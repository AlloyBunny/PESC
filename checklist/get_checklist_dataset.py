import sys
import os
import re
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(project_root)
import json
import time
import argparse
from tqdm import tqdm
from inference.llm_calls import call_llm
from checklist.prompt import criteria_prompt_template
from utils.tools import history_to_text


def extract_json(output_str: str) -> str:
    """
    从AI输出文本中提取包裹在 ```json ``` 标记内的JSON字符串
    :param ai_output: AI的完整输出文本（包含 ```json ``` 标记）
    :return: 提取出的纯JSON字符串；若未找到标记则返回空字符串
    """
    # 正则表达式匹配 ```json 开头、``` 结尾的内容（忽略开头标记的换行和空格）
    json_pattern = r'```json\s*(.*?)\s*```'
    match = re.search(json_pattern, output_str, re.DOTALL)  # re.DOTALL 让 . 匹配换行符
    if match:
        return match.group(1)
    else:
        return ""

def get_criteria(item, history_text, max_retries=10):
    """
    获取criteria，带重试机制
    :param item: 数据项
    :param history_text: 历史文本
    :param max_retries: 最大重试次数
    :return: criteria列表
    """
    for attempt in range(max_retries):
        try:
            # print(f"history_text: {history_text}")
            #######################################################
            # 调用LLM获取输出
            output_str = call_llm(criteria_prompt_template.format(
                L3_memory=item["L3_memory"], 
                L2_memory=item["L2_memory"], 
                L1_memory=item["L1_memory"],
                history=history_text
            ), llm_type=model_name)
            
            # 提取JSON内容
            json_str = extract_json(output_str)
            if not json_str:
                print(f"第{attempt + 1}次尝试：未找到JSON标记，原始输出：{output_str[:200]}...")
                if attempt < max_retries - 1:
                    continue
                else:
                    print(f"经过{max_retries}次尝试后仍无法提取JSON，返回空列表")
                    return []
            
            criteria = json.loads(json_str)
            print(f"第{attempt + 1}次尝试成功获取criteria，共{len(criteria)}项")
            #######################################################
            # criteria=[]
            #######################################################
            # print(output_str)
            # print(json_str)
            # print(criteria)
            return criteria
        except json.JSONDecodeError as e:
            print(f"第{attempt + 1}次尝试：JSON解析失败 - {e}")
            print(f"提取的JSON字符串：{json_str[:200]}...")
            if attempt < max_retries - 1:
                print(f"准备进行第{attempt + 2}次重试...")
                time.sleep(1)  # 重试前等待1秒
                continue
            else:
                print(f"经过{max_retries}次尝试后JSON解析仍然失败，返回空列表")
                return []
        except Exception as e:
            print(f"第{attempt + 1}次尝试：其他错误 - {e}")
            if attempt < max_retries - 1:
                print(f"准备进行第{attempt + 2}次重试...")
                time.sleep(1)  # 重试前等待1秒
                continue
            else:
                print(f"经过{max_retries}次尝试后仍然失败，返回空列表")
                return []
    
    return []

parser = argparse.ArgumentParser()
parser.add_argument("--model_name", type=str, default="deepseek")
args = parser.parse_args()
model_name = args.model_name

input_file = "dataset/train_dpo_without_checklist_1to1000.jsonl"
output_file = "dataset/train_dpo_with_checklist_1to1000.jsonl"
with open(input_file, "r", encoding="utf-8") as f:
    data = [json.loads(line) for line in f]
    f.close()

for item in data:
    item["criteria"] = get_criteria(item, history_to_text(item["dialog_history"]))
    with open(output_file, "a", encoding="utf-8") as f:
        f.write(json.dumps(item, ensure_ascii=False) + "\n")


"""
【输入格式】
{
    "idx": "dfead3d2ec8490b8ffa39259e366b6c8",
    "id": "34bccece-3f92-4dc5-a500-96039d908fc2",
    "dialog_history": [
        {
            "role": "system",
            "content": "你是一个智能聊天伙伴，你擅长根据用户的性格和偏好，高情商地和用户聊天，让用户感到舒适、愉快或得到需要的帮助。你需要参考以下的个性化记忆来调整你的回答，以更好地满足用户的需求。\n<顶层记忆>\n### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。\n</顶层记忆>\n<多会话记忆>\n### 性格共性反思\n结论：用户的稳定性格特质是“稳重且冷静”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：用户展现出冷静稳重的表达风格，倾向于简洁地表达观点和感受；\n2. 第3份反思（学校课程改革话题）：用户展现谨慎且冷静的思维倾向，使用简洁语言和口语化词汇；\n3. 第5份反思（学校合作沟通话题）：表现出稳重和冷静的行为倾向，通过理性分析和具体事件引导对话；\n4. 第7份反思（适应教学变化话题）：表现出稳重且冷静的性格，倾向通过具体尝试应对变化。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“喜欢获得具体建议和情感支持”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：在获得具体建议和情感支持时情绪显著上升；\n2. 第3份反思（学校课程改革话题）：对具体的行动建议和情感支持反应积极；\n3. 第4份反思（学校改革话题）：在获得具体建议和支持时情绪上升；\n4. 第5份反思（学校合作沟通话题）：情绪上升与提供具体建议和分析他人行为背后的原因有关；\n5. 第6份反思（同事相处困扰话题）：对具体可行的建议和持续的情感支持表现出积极情绪变化；\n6. 第7份反思（适应教学变化话题）：情绪上升的互动方式包括提供具体建议和分享个人经历。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及“空泛建议”未出现情绪下降，暂不列为共性。\n\n### 额外洞察总结\n用户对所有话题均展现出较强的行动意愿，特别是在“学校课程改革”、“学校合作沟通”、“适应教学变化”话题中，均提及“想实施建议”；此外，用户始终关注“自身能力提升和适应变化”，在多场景中强调通过具体尝试和沟通来推进个人或项目的进展。\n</多会话记忆>\n<会话级记忆>\n1. 话题概述：探索如何通过课堂创新和生活改变来应对职业倦怠。\n2. 对话摘要：从情绪低潮到积极探索，用户通过互动获得启发，情绪分数逐渐从40提升至100。\n3. 性格特征反思：用户表现出稳重且冷静的性格，倾向于以思考和开放态度应对倦怠，例如：通过询问具体建议来激发生活活力（引用thinking）。\n4. 用户偏好反思：具体可行的建议能明显提升用户情绪，例如：在NPC提出互动游戏、小组讨论等具体活动后，情绪分数从50提升至75（引用emotion-point变化）。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户持续寻求具体实施方案。\n6. 额外洞察反思：用户对逐步实施新方法充满期待，并计划从小项目开始试验创新活动，例如：表达了对课堂辩论和迷你项目的兴趣（引用planning）。\n</会话级记忆>"
        },
        {
            "role": "user",
            "content": "最近总觉得生活好像缺了点什么，教学也没那么有趣了，你觉得我该怎么办呢？"
        }
    ],
    "chosen": "生活和教学都是需要不断注入新鲜元素的，这样才能保持活力和激情。你之前展现过很好的冷静分析能力，可以试试从一些具体的小变化开始，比如在课堂上引入一些新的教学方法或活动。\n\n你可以尝试在课堂上加入互动性更强的小组讨论或者角色扮演游戏，这些活动不仅能激发学生的兴趣，也能让你的教学过程更有趣。另外，在生活中，考虑加入一些新的爱好或活动，比如定期的户外运动或者参加一个新的课程。不妨从一个小项目开始，比如尝试每周一次的课堂辩论或者迷你项目，看看它如何改变课堂氛围。\n\n如果有具体的教学活动或者生活项目想法，我很乐意帮你进一步细化计划哦！这样不仅能让生活更充实，也能让教学更加生动有趣。",
    "rejected": "听起来你正在经历一种情绪上的低潮，这是很正常的，有时候我们都会遇到这样的阶段。也许你可以尝试做一些小改变，让生活重新焕发活力。比如，在教学中加入一些新的元素或活动，可能会让课堂更有趣些。另外，找到一些能够激发你灵感的事情或爱好，比如读一本好书、听音乐、或者尝试冥想和运动，都可能会让你感觉更好。最重要的是，给自己一些时间和空间，不要过于勉强自己。你一直以来的努力都是值得的，生活中的小改变可能会带来意想不到的收获！如果需要进一步的支持或建议，随时可以和我聊聊。",
    "criteria": [],
    "gold": "",
    "split": "hard",
    "L3_memory": "### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。",
    "L2_memory": "### 性格共性反思\n结论：用户的稳定性格特质是“稳重且冷静”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：用户展现出冷静稳重的表达风格，倾向于简洁地表达观点和感受；\n2. 第3份反思（学校课程改革话题）：用户展现谨慎且冷静的思维倾向，使用简洁语言和口语化词汇；\n3. 第5份反思（学校合作沟通话题）：表现出稳重和冷静的行为倾向，通过理性分析和具体事件引导对话；\n4. 第7份反思（适应教学变化话题）：表现出稳重且冷静的性格，倾向通过具体尝试应对变化。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“喜欢获得具体建议和情感支持”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：在获得具体建议和情感支持时情绪显著上升；\n2. 第3份反思（学校课程改革话题）：对具体的行动建议和情感支持反应积极；\n3. 第4份反思（学校改革话题）：在获得具体建议和支持时情绪上升；\n4. 第5份反思（学校合作沟通话题）：情绪上升与提供具体建议和分析他人行为背后的原因有关；\n5. 第6份反思（同事相处困扰话题）：对具体可行的建议和持续的情感支持表现出积极情绪变化；\n6. 第7份反思（适应教学变化话题）：情绪上升的互动方式包括提供具体建议和分享个人经历。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及“空泛建议”未出现情绪下降，暂不列为共性。\n\n### 额外洞察总结\n用户对所有话题均展现出较强的行动意愿，特别是在“学校课程改革”、“学校合作沟通”、“适应教学变化”话题中，均提及“想实施建议”；此外，用户始终关注“自身能力提升和适应变化”，在多场景中强调通过具体尝试和沟通来推进个人或项目的进展。",
    "L1_memory": "1. 话题概述：探索如何通过课堂创新和生活改变来应对职业倦怠。\n2. 对话摘要：从情绪低潮到积极探索，用户通过互动获得启发，情绪分数逐渐从40提升至100。\n3. 性格特征反思：用户表现出稳重且冷静的性格，倾向于以思考和开放态度应对倦怠，例如：通过询问具体建议来激发生活活力（引用thinking）。\n4. 用户偏好反思：具体可行的建议能明显提升用户情绪，例如：在NPC提出互动游戏、小组讨论等具体活动后，情绪分数从50提升至75（引用emotion-point变化）。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户持续寻求具体实施方案。\n6. 额外洞察反思：用户对逐步实施新方法充满期待，并计划从小项目开始试验创新活动，例如：表达了对课堂辩论和迷你项目的兴趣（引用planning）。",
    "infer_model": "gpt4o",
    "temperature": 0.7
}
【输出格式】
{
    "idx": 0,
    "dialog_history": [
        {
            "role": "system",
            "content": "你是一个智能聊天伙伴，你擅长根据用户的性格和偏好，高情商地和用户聊天，让用户感到舒适、愉快或得到需要的帮助。你需要参考以下的个性化记忆来调整你的回答，以更好地满足用户的需求。\n<顶层记忆>\n### 核心性格特质\n结论：用户的核心性格是“倾向于间接表达情感，通过细腻的比喻传达情感和感受”，在艺术创作、职业困惑、社交压力、家庭问题等所有关键场景中均有体现。\n依据：\n1. 第1份共性反思：提及用户在艺术创作、工作困境中使用比喻表达情感，如“像在黑夜里走，只有点点星光”；\n2. 第2份共性反思：用户在职业和家庭话题中通过隐喻如“暴风雨”“玻璃瓶”描述内心困惑；\n3. 第3份共性反思：在婚姻、职业生涯中用“雾”比喻表达情感；\n4. 第4份共性反思：在社交和创作中使用比喻如“在雾里找路”；\n5. 第5份共性反思：在经济和创作场景中用比喻如“在森林里寻找光亮”表达感受；\n6. 第6份共性反思：在创作和插画项目中通过“走在无尽的森林小径上”传达情感。\n\n### 核心偏好规律\n结论：用户的核心偏好是“偏好获得深刻的情感共鸣和具体可操作的建议”，情绪正向反馈均源于此逻辑。\n依据：\n1. 第1份共性反思：在艺术创作、工作困境中，用户在获得共情和具体建议时情绪上升；\n2. 第2份共性反思：在职业、家庭、照顾母亲的场景中，对情感共鸣情绪上升；\n3. 第3份共性反思：在婚姻、创作中，情绪因听到他人成功故事和共鸣有所改善；\n4. 第4份共性反思：在社交压力、经济困境中，对情感支持和具体建议情绪提升；\n5. 第5份共性反思：在创作和插画场景中，用户在获得情感理解和具体建议时情绪上升。\n\n### 核心雷点清单\n1. 缺乏情感共鸣的建议：在多份共性反思中，用户对缺乏深刻共鸣和情感深度的建议表现出负面情绪，情绪分数明显下降；\n2. 对空泛建议抵触：用户在多个场景中对泛泛建议表现出抵触情绪。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“深刻情感共鸣”和“具体细节/可操作建议”，避免“加油”“多努力”等空泛表述。\n2. 语气原则：需通过细腻的语言表达理解和共鸣，再输出建议，贴合其倾向于间接表达的性格。\n3. 避坑原则：绝对避免“缺乏情感共鸣”和“泛泛无细节”两类表述，确保建议富有情感深度和具体可行性。\n4. 情绪响应原则：若用户情绪分低于40，优先通过具体成功故事和细腻理解引导，而非仅提供实用建议，贴合其偏好逻辑。\n</顶层记忆>\n<多会话记忆>\n### 性格共性反思\n结论：用户的稳定性格特质是“倾向于通过细腻的比喻和间接表达情感”，在艺术创作、身体受伤及工作困境、创作合作、团队表达、孤独感、社交及职业方向等场景中均有体现。\n证据：\n1. 第1份反思（艺术创作话题）：用户通过比喻“像在黑夜里走，只有点点星光”表达情感，体现出间接表达的倾向；\n2. 第2份反思（身体受伤及工作困境话题）：使用“像在一条看不见的河里漂着”传达困惑，展现细腻表达；\n3. 第3份反思（创作合作话题）：将创作比作“在雾中摸索”，体现细腻表达的特质；\n4. 第5份反思（孤独感话题）：使用“孤独就像厚厚的雾”间接表达情感；\n5. 第6份反思（社交及职业方向话题）：通过“迷失在森林”表达困惑，符合间接表达的性格特征；\n6. 第7份反思（职业困惑话题）：比喻“就像在黑暗里找星星”展现细腻且间接的表达方式。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“偏好获得深刻的情感共鸣和具体可操作的建议”，在艺术创作、身体受伤及工作困境、创作合作、团队表达、孤独感、社交及职业方向、洪水后无助感等场景中均有体现。\n证据：\n1. 第1份反思（艺术创作话题）：用户情绪在得到共情和理解时略有提升；\n2. 第2份反思（身体受伤及工作困境话题）：情绪因温暖支持和共情显著上升；\n3. 第3份反思（创作合作话题）：用户情绪在获得共情和倾听时提升；\n4. 第4份反思（团队表达话题）：情绪因共情和具体建议的互动上升；\n5. 第5份反思（孤独感话题）：用户对情感共鸣的回应情绪上升；\n6. 第6份反思（社交及职业方向话题）：在感受到一定安慰和理解时情绪上升；\n7. 第7份反思（洪水后无助感话题）：情绪在具体建议和温暖支持下显著上升。\n\n### 潜在雷点列表\n1. 暂未发现跨场景雷点，仅在单一场景提及用户对缺乏深层情感共鸣的建议感到失望，但未显著影响情绪，暂不列为共性。\n\n### 额外洞察总结\n用户在对多个话题的对话中均表现出对深刻理解和具体指导的强烈需求，特别是在艺术创作、职业选择、身体受伤、和社交场合中，显示出对情感支持和具体行动方向的持续渴望。此外，用户在多场景中均表现出较强的行动意愿和对未来方向的追求，尽管面临困境，仍保持寻找出路的积极态度。\n</多会话记忆>\n<会话级记忆>\n1. 话题概述：对话围绕用户在工作压力下的孤独感展开，用户希望有人能理解她内心的情感。\n2. 对话摘要：用户多次表达了因工作压力导致的孤独感，尽管AI提供了建议和支持，但用户情绪从40下降到10，表示仍未获得期望的理解和共情。\n3. 性格特征反思：用户倾向于通过委婉的表达方式来描述自己的情感和困惑，例如在思考记录中提到希望以委婉的方式表达失落感。\n4. 用户偏好反思：用户在获得更深层次的情感共情时情绪有所好转，例如在AI尝试表达对用户复杂情绪的理解时，情绪分数略有上升。\n5. 潜在雷点反思：用户对空泛的建议和缺乏深刻共情的回应情绪下降明显，例如在AI仅提供一般性的安慰和建议时，情绪分数从35降至30。\n6. 额外洞察反思：用户对通过艺术如博物馆参观来舒缓压力的方式展现出一定的兴趣，这表明她可能愿意通过文化活动来寻找内心的宁静，例如在最后一次提到博物馆时感到稍微放松。\n</会话级记忆>"
        },
        {
            "role": "user",
            "content": "最近工作上的压力让我有些喘不过气来，真的需要一些建议。"
        }
    ],
    "gold": "",
    "split": "hard",
    "criteria": [
        [
            "回应需通过细腻的语言和比喻表达方式来传达对用户的理解和共情（例如，使用隐喻来描绘用户的情感状态）",
            "主需",
            "风格约束",
            "间接表达约束"
        ],
        [
            "提供的建议必须具体、细节明确，并与用户表达的情感状态相匹配（例如，通过艺术活动如参观博物馆来舒缓压力）",
            "主需",
            "建议方式约束",
            "具体与情境相关约束"
        ],
        [
            "避免使用空泛、无细节的鼓励性语言，如“加油”或“多努力”，应提供具有情感深度的支持",
            "主需",
            "内容质量约束",
            "反空洞与无细节约束"
        ],
        [
            "在情感共鸣方面，应深度理解用户的情感复杂性，使用比喻或故事来展示这一理解",
            "主需",
            "情感共情约束",
            "深度共情约束"
        ],
        [
            "提供的支持应避免单纯的策略性建议，而需包含对用户情感状态的深刻共鸣，以此为前提展开具体建议",
            "主需",
            "互动策略约束",
            "情感先行约束"
        ],
        [
            "当用户提到孤独感时，回应应优先考虑在情感上给予支持和理解，并通过细腻语言和比喻表达共情",
            "次需",
            "情感共情约束",
            "孤独感共情约束"
        ],
        [
            "在提供建议时，需强调其可操作性和与用户当前情感状态的相关性，防止情绪进一步下降",
            "次需",
            "建议方式约束",
            "操作性与情境相关约束"
        ]
    ],
    "L3_memory": "### 核心性格特质\n结论：用户的核心性格是“倾向于间接表达情感，通过细腻的比喻传达情感和感受”，在艺术创作、职业困惑、社交压力、家庭问题等所有关键场景中均有体现。\n依据：\n1. 第1份共性反思：提及用户在艺术创作、工作困境中使用比喻表达情感，如“像在黑夜里走，只有点点星光”；\n2. 第2份共性反思：用户在职业和家庭话题中通过隐喻如“暴风雨”“玻璃瓶”描述内心困惑；\n3. 第3份共性反思：在婚姻、职业生涯中用“雾”比喻表达情感；\n4. 第4份共性反思：在社交和创作中使用比喻如“在雾里找路”；\n5. 第5份共性反思：在经济和创作场景中用比喻如“在森林里寻找光亮”表达感受；\n6. 第6份共性反思：在创作和插画项目中通过“走在无尽的森林小径上”传达情感。\n\n### 核心偏好规律\n结论：用户的核心偏好是“偏好获得深刻的情感共鸣和具体可操作的建议”，情绪正向反馈均源于此逻辑。\n依据：\n1. 第1份共性反思：在艺术创作、工作困境中，用户在获得共情和具体建议时情绪上升；\n2. 第2份共性反思：在职业、家庭、照顾母亲的场景中，对情感共鸣情绪上升；\n3. 第3份共性反思：在婚姻、创作中，情绪因听到他人成功故事和共鸣有所改善；\n4. 第4份共性反思：在社交压力、经济困境中，对情感支持和具体建议情绪提升；\n5. 第5份共性反思：在创作和插画场景中，用户在获得情感理解和具体建议时情绪上升。\n\n### 核心雷点清单\n1. 缺乏情感共鸣的建议：在多份共性反思中，用户对缺乏深刻共鸣和情感深度的建议表现出负面情绪，情绪分数明显下降；\n2. 对空泛建议抵触：用户在多个场景中对泛泛建议表现出抵触情绪。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“深刻情感共鸣”和“具体细节/可操作建议”，避免“加油”“多努力”等空泛表述。\n2. 语气原则：需通过细腻的语言表达理解和共鸣，再输出建议，贴合其倾向于间接表达的性格。\n3. 避坑原则：绝对避免“缺乏情感共鸣”和“泛泛无细节”两类表述，确保建议富有情感深度和具体可行性。\n4. 情绪响应原则：若用户情绪分低于40，优先通过具体成功故事和细腻理解引导，而非仅提供实用建议，贴合其偏好逻辑。",
    "L2_memory": "### 性格共性反思\n结论：用户的稳定性格特质是“倾向于通过细腻的比喻和间接表达情感”，在艺术创作、身体受伤及工作困境、创作合作、团队表达、孤独感、社交及职业方向等场景中均有体现。\n证据：\n1. 第1份反思（艺术创作话题）：用户通过比喻“像在黑夜里走，只有点点星光”表达情感，体现出间接表达的倾向；\n2. 第2份反思（身体受伤及工作困境话题）：使用“像在一条看不见的河里漂着”传达困惑，展现细腻表达；\n3. 第3份反思（创作合作话题）：将创作比作“在雾中摸索”，体现细腻表达的特质；\n4. 第5份反思（孤独感话题）：使用“孤独就像厚厚的雾”间接表达情感；\n5. 第6份反思（社交及职业方向话题）：通过“迷失在森林”表达困惑，符合间接表达的性格特征；\n6. 第7份反思（职业困惑话题）：比喻“就像在黑暗里找星星”展现细腻且间接的表达方式。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“偏好获得深刻的情感共鸣和具体可操作的建议”，在艺术创作、身体受伤及工作困境、创作合作、团队表达、孤独感、社交及职业方向、洪水后无助感等场景中均有体现。\n证据：\n1. 第1份反思（艺术创作话题）：用户情绪在得到共情和理解时略有提升；\n2. 第2份反思（身体受伤及工作困境话题）：情绪因温暖支持和共情显著上升；\n3. 第3份反思（创作合作话题）：用户情绪在获得共情和倾听时提升；\n4. 第4份反思（团队表达话题）：情绪因共情和具体建议的互动上升；\n5. 第5份反思（孤独感话题）：用户对情感共鸣的回应情绪上升；\n6. 第6份反思（社交及职业方向话题）：在感受到一定安慰和理解时情绪上升；\n7. 第7份反思（洪水后无助感话题）：情绪在具体建议和温暖支持下显著上升。\n\n### 潜在雷点列表\n1. 暂未发现跨场景雷点，仅在单一场景提及用户对缺乏深层情感共鸣的建议感到失望，但未显著影响情绪，暂不列为共性。\n\n### 额外洞察总结\n用户在对多个话题的对话中均表现出对深刻理解和具体指导的强烈需求，特别是在艺术创作、职业选择、身体受伤、和社交场合中，显示出对情感支持和具体行动方向的持续渴望。此外，用户在多场景中均表现出较强的行动意愿和对未来方向的追求，尽管面临困境，仍保持寻找出路的积极态度。",
    "L1_memory": "1. 话题概述：对话围绕用户在工作压力下的孤独感展开，用户希望有人能理解她内心的情感。\n2. 对话摘要：用户多次表达了因工作压力导致的孤独感，尽管AI提供了建议和支持，但用户情绪从40下降到10，表示仍未获得期望的理解和共情。\n3. 性格特征反思：用户倾向于通过委婉的表达方式来描述自己的情感和困惑，例如在思考记录中提到希望以委婉的方式表达失落感。\n4. 用户偏好反思：用户在获得更深层次的情感共情时情绪有所好转，例如在AI尝试表达对用户复杂情绪的理解时，情绪分数略有上升。\n5. 潜在雷点反思：用户对空泛的建议和缺乏深刻共情的回应情绪下降明显，例如在AI仅提供一般性的安慰和建议时，情绪分数从35降至30。\n6. 额外洞察反思：用户对通过艺术如博物馆参观来舒缓压力的方式展现出一定的兴趣，这表明她可能愿意通过文化活动来寻找内心的宁静，例如在最后一次提到博物馆时感到稍微放松。",
    "response": "听起来你确实面临着一些挑战，工作压力有时候真的很难处理。首先，我想说能够意识到自己需要帮助是非常好的第一步。以下是一些可能对你有帮助的方法：\n\n1. **优先排序**：试着列出你的任务清单，区分哪些是紧急且重要的，优先处理这些任务。这样可以帮助你更好地安排时间，减少压力。\n\n2. **合理休息**：确保自己有足够的休息时间，哪怕是短暂的休息也能让你恢复精力。尝试每天留出一段时间做自己喜欢的事情，无论是读书、运动还是简单的冥想。\n\n3. **与人交流**：有时候和同事或朋友分享你的感受可以减轻负担，他们可能也会给你一些有用的建议或者只是提供一个倾诉的空间。\n\n4. **设定界限**：学会说“不”，避免承担过多的任务。确保你的工作量是合理的，避免过度加班，以免影响身心健康。\n\n5. **保持健康的生活方式**：均衡饮食、定期运动和充足睡眠对减轻压力都很有帮助。\n\n记住，压力是生活的一部分，但我们可以学习如何更好地应对。希望这些建议能对你有所帮助，如果需要更多的支持，请随时告诉我。",
    "infer_model": "Qwen2_5_7B_Instruct_sft",
    "iteration": 0,
    "temperature": 0.7
}
"""