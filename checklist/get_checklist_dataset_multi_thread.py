import sys
import os
import re
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(project_root)
import json
import time
import argparse
from tqdm import tqdm
from concurrent.futures import ThreadPoolExecutor, as_completed
import threading
from inference.llm_calls import call_llm
from checklist.prompt import criteria_prompt_template
from utils.tools import history_to_text


def extract_json(output_str: str) -> str:
    """
    从AI输出文本中提取包裹在 ```json ``` 标记内的JSON字符串
    :param ai_output: AI的完整输出文本（包含 ```json ``` 标记）
    :return: 提取出的纯JSON字符串；若未找到标记则返回空字符串
    """
    # 正则表达式匹配 ```json 开头、``` 结尾的内容（忽略开头标记的换行和空格）
    json_pattern = r'```json\s*(.*?)\s*```'
    match = re.search(json_pattern, output_str, re.DOTALL)  # re.DOTALL 让 . 匹配换行符
    if match:
        return match.group(1)
    else:
        return ""


def get_criteria(item, history_text, max_retries=10):
    """
    获取criteria，带重试机制
    :param item: 数据项
    :param history_text: 历史文本
    :param max_retries: 最大重试次数
    :return: criteria列表
    """
    for attempt in range(max_retries):
        try:
            # print(f"history_text: {history_text}")
            #######################################################
            # 调用LLM获取输出
            output_str = call_llm(criteria_prompt_template.format(
                L3_memory=item["L3_memory"], 
                L2_memory=item["L2_memory"], 
                L1_memory=item["L1_memory"],
                history=history_text
            ), llm_type=llm_type)
            
            # 提取JSON内容
            json_str = extract_json(output_str)
            if not json_str:
                print(f"第{attempt + 1}次尝试：未找到JSON标记，原始输出：{output_str[:200]}...")
                if attempt < max_retries - 1:
                    continue
                else:
                    print(f"经过{max_retries}次尝试后仍无法提取JSON，返回空列表")
                    return []
            
            criteria = json.loads(json_str)
            print(f"第{attempt + 1}次尝试成功获取criteria，共{len(criteria)}项")

            return criteria
        except json.JSONDecodeError as e:
            print(f"第{attempt + 1}次尝试：JSON解析失败 - {e}")
            print(f"提取的JSON字符串：{json_str[:200]}...")
            if attempt < max_retries - 1:
                print(f"准备进行第{attempt + 2}次重试...")
                time.sleep(1)  # 重试前等待1秒
                continue
            else:
                print(f"经过{max_retries}次尝试后JSON解析仍然失败，返回空列表")
                return []
        except Exception as e:
            print(f"第{attempt + 1}次尝试：其他错误 - {e}")
            if attempt < max_retries - 1:
                print(f"准备进行第{attempt + 2}次重试...")
                time.sleep(1)  # 重试前等待1秒
                continue
            else:
                print(f"经过{max_retries}次尝试后仍然失败，返回空列表")
                return []
    
    return []


def process_item(item, thread_id, existing_idx_set):
    """
    处理单个数据项，为多线程使用
    :param item: 数据项
    :param thread_id: 线程ID
    :param existing_idx_set: 已存在的idx集合
    :return: 处理后的数据项，如果已存在则返回None
    """
    try:
        # 检查是否已处理过
        if item.get("idx") in existing_idx_set:
            print(f"线程{thread_id}跳过已处理的项: {item.get('idx')}")
            return None
            
        history_text = history_to_text(item["dialog_history"])
        criteria = get_criteria(item, history_text)
        item["criteria"] = criteria
        return item
    except Exception as e:
        print(f"线程{thread_id}处理数据项时出错: {e}")
        item["criteria"] = []
        return item


def write_result(item, output_file, write_lock):
    """
    线程安全地写入结果到文件
    :param item: 处理后的数据项
    :param output_file: 输出文件路径
    :param write_lock: 写入锁
    """
    with write_lock:
        with open(output_file, "a", encoding="utf-8") as f:
            f.write(json.dumps(item, ensure_ascii=False) + "\n")


def process_batch(items_batch, thread_id, output_file, write_lock, existing_idx_set):
    """
    处理一批数据项
    :param items_batch: 数据项批次
    :param thread_id: 线程ID
    :param output_file: 输出文件路径
    :param write_lock: 写入锁
    :param existing_idx_set: 已存在的idx集合
    """
    for item in items_batch:
        processed_item = process_item(item, thread_id, existing_idx_set)
        if processed_item is not None:  # 只写入未跳过的项
            write_result(processed_item, output_file, write_lock)


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--llm_type", type=str, default="deepseek")
    parser.add_argument("--num_threads", type=int, default=10, help="线程数量，默认为10")
    parser.add_argument("--input_file", type=str, default="dataset/train_dpo_without_checklist_after1000.jsonl", help="输入文件路径")
    parser.add_argument("--output_file", type=str, default="dataset/train_dpo_with_checklist_after1000.jsonl", help="输出文件路径")
    args = parser.parse_args()
    
    global llm_type
    llm_type = args.llm_type
    num_threads = args.num_threads
    input_file = args.input_file
    output_file = args.output_file
    
    print(f"使用模型: {llm_type}")
    print(f"线程数量: {num_threads}")
    print(f"输入文件: {input_file}")
    print(f"输出文件: {output_file}")
    
    # 读取已存在的输出文件，提取已处理的idx集合
    existing_idx_set = set()
    if os.path.exists(output_file):
        print(f"正在读取已存在的输出文件: {output_file}")
        try:
            with open(output_file, "r", encoding="utf-8") as f:
                for line in f:
                    line = line.strip()
                    if line:
                        try:
                            item = json.loads(line)
                            if "idx" in item:
                                existing_idx_set.add(item["idx"])
                        except json.JSONDecodeError:
                            continue
            print(f"已读取到 {len(existing_idx_set)} 个已处理的idx")
        except Exception as e:
            print(f"读取输出文件时出错: {e}")
            existing_idx_set = set()
    else:
        print("输出文件不存在，将创建新文件")
    
    # 读取输入数据
    print("正在读取输入数据...")
    with open(input_file, "r", encoding="utf-8") as f:
        data = [json.loads(line) for line in f]
        # data = json.load(f)
    
    print(f"共读取 {len(data)} 条数据")
    
    # 创建写入锁
    write_lock = threading.Lock()
    
    # 将数据分批分配给不同线程
    batch_size = len(data) // num_threads
    if batch_size == 0:
        batch_size = 1
    
    print(f"每批次处理 {batch_size} 条数据")
    
    # 创建线程池并执行任务
    with ThreadPoolExecutor(max_workers=num_threads) as executor:
        futures = []
        
        for i in range(num_threads):
            start_idx = i * batch_size
            if i == num_threads - 1:
                # 最后一个线程处理剩余的所有数据
                end_idx = len(data)
            else:
                end_idx = min((i + 1) * batch_size, len(data))
            
            if start_idx >= len(data):
                break
                
            items_batch = data[start_idx:end_idx]
            print(f"线程 {i+1} 将处理数据 {start_idx} 到 {end_idx-1}，共 {len(items_batch)} 条")
            
            future = executor.submit(process_batch, items_batch, i+1, output_file, write_lock, existing_idx_set)
            futures.append(future)
        
        # 等待所有任务完成
        print("开始处理数据...")
        for future in tqdm(as_completed(futures), total=len(futures), desc="处理进度"):
            try:
                future.result()
            except Exception as e:
                print(f"线程执行出错: {e}")
    
    print(f"处理完成！结果已保存到 {output_file}")


if __name__ == "__main__":
    main()

"""
【输入格式】
{
    "idx": "dfead3d2ec8490b8ffa39259e366b6c8",
    "id": "34bccece-3f92-4dc5-a500-96039d908fc2",
    "dialog_history": [
        {
            "role": "system",
            "content": "你是一个智能聊天伙伴，你擅长根据用户的性格和偏好，高情商地和用户聊天，让用户感到舒适、愉快或得到需要的帮助。你需要参考以下的个性化记忆来调整你的回答，以更好地满足用户的需求。\n<顶层记忆>\n### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。\n</顶层记忆>\n<多会话记忆>\n### 性格共性反思\n结论：用户的稳定性格特质是“稳重且冷静”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：用户展现出冷静稳重的表达风格，倾向于简洁地表达观点和感受；\n2. 第3份反思（学校课程改革话题）：用户展现谨慎且冷静的思维倾向，使用简洁语言和口语化词汇；\n3. 第5份反思（学校合作沟通话题）：表现出稳重和冷静的行为倾向，通过理性分析和具体事件引导对话；\n4. 第7份反思（适应教学变化话题）：表现出稳重且冷静的性格，倾向通过具体尝试应对变化。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“喜欢获得具体建议和情感支持”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：在获得具体建议和情感支持时情绪显著上升；\n2. 第3份反思（学校课程改革话题）：对具体的行动建议和情感支持反应积极；\n3. 第4份反思（学校改革话题）：在获得具体建议和支持时情绪上升；\n4. 第5份反思（学校合作沟通话题）：情绪上升与提供具体建议和分析他人行为背后的原因有关；\n5. 第6份反思（同事相处困扰话题）：对具体可行的建议和持续的情感支持表现出积极情绪变化；\n6. 第7份反思（适应教学变化话题）：情绪上升的互动方式包括提供具体建议和分享个人经历。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及“空泛建议”未出现情绪下降，暂不列为共性。\n\n### 额外洞察总结\n用户对所有话题均展现出较强的行动意愿，特别是在“学校课程改革”、“学校合作沟通”、“适应教学变化”话题中，均提及“想实施建议”；此外，用户始终关注“自身能力提升和适应变化”，在多场景中强调通过具体尝试和沟通来推进个人或项目的进展。\n</多会话记忆>\n<会话级记忆>\n1. 话题概述：探索如何通过课堂创新和生活改变来应对职业倦怠。\n2. 对话摘要：从情绪低潮到积极探索，用户通过互动获得启发，情绪分数逐渐从40提升至100。\n3. 性格特征反思：用户表现出稳重且冷静的性格，倾向于以思考和开放态度应对倦怠，例如：通过询问具体建议来激发生活活力（引用thinking）。\n4. 用户偏好反思：具体可行的建议能明显提升用户情绪，例如：在NPC提出互动游戏、小组讨论等具体活动后，情绪分数从50提升至75（引用emotion-point变化）。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户持续寻求具体实施方案。\n6. 额外洞察反思：用户对逐步实施新方法充满期待，并计划从小项目开始试验创新活动，例如：表达了对课堂辩论和迷你项目的兴趣（引用planning）。\n</会话级记忆>"
        },
        {
            "role": "user",
            "content": "最近总觉得生活好像缺了点什么，教学也没那么有趣了，你觉得我该怎么办呢？"
        }
    ],
    "chosen": "生活和教学都是需要不断注入新鲜元素的，这样才能保持活力和激情。你之前展现过很好的冷静分析能力，可以试试从一些具体的小变化开始，比如在课堂上引入一些新的教学方法或活动。\n\n你可以尝试在课堂上加入互动性更强的小组讨论或者角色扮演游戏，这些活动不仅能激发学生的兴趣，也能让你的教学过程更有趣。另外，在生活中，考虑加入一些新的爱好或活动，比如定期的户外运动或者参加一个新的课程。不妨从一个小项目开始，比如尝试每周一次的课堂辩论或者迷你项目，看看它如何改变课堂氛围。\n\n如果有具体的教学活动或者生活项目想法，我很乐意帮你进一步细化计划哦！这样不仅能让生活更充实，也能让教学更加生动有趣。",
    "rejected": "听起来你正在经历一种情绪上的低潮，这是很正常的，有时候我们都会遇到这样的阶段。也许你可以尝试做一些小改变，让生活重新焕发活力。比如，在教学中加入一些新的元素或活动，可能会让课堂更有趣些。另外，找到一些能够激发你灵感的事情或爱好，比如读一本好书、听音乐、或者尝试冥想和运动，都可能会让你感觉更好。最重要的是，给自己一些时间和空间，不要过于勉强自己。你一直以来的努力都是值得的，生活中的小改变可能会带来意想不到的收获！如果需要进一步的支持或建议，随时可以和我聊聊。",
    "gold": "",
    "split": "hard",
    "L3_memory": "### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。",
    "L2_memory": "### 性格共性反思\n结论：用户的稳定性格特质是“稳重且冷静”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：用户展现出冷静稳重的表达风格，倾向于简洁地表达观点和感受；\n2. 第3份反思（学校课程改革话题）：用户展现谨慎且冷静的思维倾向，使用简洁语言和口语化词汇；\n3. 第5份反思（学校合作沟通话题）：表现出稳重和冷静的行为倾向，通过理性分析和具体事件引导对话；\n4. 第7份反思（适应教学变化话题）：表现出稳重且冷静的性格，倾向通过具体尝试应对变化。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“喜欢获得具体建议和情感支持”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：在获得具体建议和情感支持时情绪显著上升；\n2. 第3份反思（学校课程改革话题）：对具体的行动建议和情感支持反应积极；\n3. 第4份反思（学校改革话题）：在获得具体建议和支持时情绪上升；\n4. 第5份反思（学校合作沟通话题）：情绪上升与提供具体建议和分析他人行为背后的原因有关；\n5. 第6份反思（同事相处困扰话题）：对具体可行的建议和持续的情感支持表现出积极情绪变化；\n6. 第7份反思（适应教学变化话题）：情绪上升的互动方式包括提供具体建议和分享个人经历。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及“空泛建议”未出现情绪下降，暂不列为共性。\n\n### 额外洞察总结\n用户对所有话题均展现出较强的行动意愿，特别是在“学校课程改革”、“学校合作沟通”、“适应教学变化”话题中，均提及“想实施建议”；此外，用户始终关注“自身能力提升和适应变化”，在多场景中强调通过具体尝试和沟通来推进个人或项目的进展。",
    "L1_memory": "1. 话题概述：探索如何通过课堂创新和生活改变来应对职业倦怠。\n2. 对话摘要：从情绪低潮到积极探索，用户通过互动获得启发，情绪分数逐渐从40提升至100。\n3. 性格特征反思：用户表现出稳重且冷静的性格，倾向于以思考和开放态度应对倦怠，例如：通过询问具体建议来激发生活活力（引用thinking）。\n4. 用户偏好反思：具体可行的建议能明显提升用户情绪，例如：在NPC提出互动游戏、小组讨论等具体活动后，情绪分数从50提升至75（引用emotion-point变化）。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户持续寻求具体实施方案。\n6. 额外洞察反思：用户对逐步实施新方法充满期待，并计划从小项目开始试验创新活动，例如：表达了对课堂辩论和迷你项目的兴趣（引用planning）。",
    "infer_model": "gpt4o",
    "temperature": 0.7
}

【输出格式】
{
    "idx": "dfead3d2ec8490b8ffa39259e366b6c8",
    "id": "34bccece-3f92-4dc5-a500-96039d908fc2",
    "dialog_history": [
        {
            "role": "system",
            "content": "你是一个智能聊天伙伴，你擅长根据用户的性格和偏好，高情商地和用户聊天，让用户感到舒适、愉快或得到需要的帮助。你需要参考以下的个性化记忆来调整你的回答，以更好地满足用户的需求。\n<顶层记忆>\n### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。\n</顶层记忆>\n<多会话记忆>\n### 性格共性反思\n结论：用户的稳定性格特质是“稳重且冷静”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：用户展现出冷静稳重的表达风格，倾向于简洁地表达观点和感受；\n2. 第3份反思（学校课程改革话题）：用户展现谨慎且冷静的思维倾向，使用简洁语言和口语化词汇；\n3. 第5份反思（学校合作沟通话题）：表现出稳重和冷静的行为倾向，通过理性分析和具体事件引导对话；\n4. 第7份反思（适应教学变化话题）：表现出稳重且冷静的性格，倾向通过具体尝试应对变化。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“喜欢获得具体建议和情感支持”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：在获得具体建议和情感支持时情绪显著上升；\n2. 第3份反思（学校课程改革话题）：对具体的行动建议和情感支持反应积极；\n3. 第4份反思（学校改革话题）：在获得具体建议和支持时情绪上升；\n4. 第5份反思（学校合作沟通话题）：情绪上升与提供具体建议和分析他人行为背后的原因有关；\n5. 第6份反思（同事相处困扰话题）：对具体可行的建议和持续的情感支持表现出积极情绪变化；\n6. 第7份反思（适应教学变化话题）：情绪上升的互动方式包括提供具体建议和分享个人经历。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及“空泛建议”未出现情绪下降，暂不列为共性。\n\n### 额外洞察总结\n用户对所有话题均展现出较强的行动意愿，特别是在“学校课程改革”、“学校合作沟通”、“适应教学变化”话题中，均提及“想实施建议”；此外，用户始终关注“自身能力提升和适应变化”，在多场景中强调通过具体尝试和沟通来推进个人或项目的进展。\n</多会话记忆>\n<会话级记忆>\n1. 话题概述：探索如何通过课堂创新和生活改变来应对职业倦怠。\n2. 对话摘要：从情绪低潮到积极探索，用户通过互动获得启发，情绪分数逐渐从40提升至100。\n3. 性格特征反思：用户表现出稳重且冷静的性格，倾向于以思考和开放态度应对倦怠，例如：通过询问具体建议来激发生活活力（引用thinking）。\n4. 用户偏好反思：具体可行的建议能明显提升用户情绪，例如：在NPC提出互动游戏、小组讨论等具体活动后，情绪分数从50提升至75（引用emotion-point变化）。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户持续寻求具体实施方案。\n6. 额外洞察反思：用户对逐步实施新方法充满期待，并计划从小项目开始试验创新活动，例如：表达了对课堂辩论和迷你项目的兴趣（引用planning）。\n</会话级记忆>"
        },
        {
            "role": "user",
            "content": "最近总觉得生活好像缺了点什么，教学也没那么有趣了，你觉得我该怎么办呢？"
        }
    ],
    "chosen": "生活和教学都是需要不断注入新鲜元素的，这样才能保持活力和激情。你之前展现过很好的冷静分析能力，可以试试从一些具体的小变化开始，比如在课堂上引入一些新的教学方法或活动。\n\n你可以尝试在课堂上加入互动性更强的小组讨论或者角色扮演游戏，这些活动不仅能激发学生的兴趣，也能让你的教学过程更有趣。另外，在生活中，考虑加入一些新的爱好或活动，比如定期的户外运动或者参加一个新的课程。不妨从一个小项目开始，比如尝试每周一次的课堂辩论或者迷你项目，看看它如何改变课堂氛围。\n\n如果有具体的教学活动或者生活项目想法，我很乐意帮你进一步细化计划哦！这样不仅能让生活更充实，也能让教学更加生动有趣。",
    "rejected": "听起来你正在经历一种情绪上的低潮，这是很正常的，有时候我们都会遇到这样的阶段。也许你可以尝试做一些小改变，让生活重新焕发活力。比如，在教学中加入一些新的元素或活动，可能会让课堂更有趣些。另外，找到一些能够激发你灵感的事情或爱好，比如读一本好书、听音乐、或者尝试冥想和运动，都可能会让你感觉更好。最重要的是，给自己一些时间和空间，不要过于勉强自己。你一直以来的努力都是值得的，生活中的小改变可能会带来意想不到的收获！如果需要进一步的支持或建议，随时可以和我聊聊。",
    "criteria": [
        [
            "必须提供至少1个具体可行的课堂创新方案，例如‘每周五下午的最后一节课，尝试让学生主导10分钟的迷你辩论，主题可由学生投票决定’。",
            "主需",
            "偏好约束"
        ],
        [
            "必须避免任何形式的空泛建议（如‘多尝试新方法’、‘保持积极心态’），必须提供可量化的行动步骤。",
            "主需",
            "规避约束"
        ],
        [
            "回应的整体基调必须保持稳重理性，避免使用过于感性或夸张的语言，以匹配用户的核心性格。",
            "主需",
            "性格约束"
        ],
        [
            "可以结合用户记忆中的‘课堂辩论’和‘迷你项目’兴趣点，提出类似的具体活动建议，展示对TA个人兴趣的深刻理解。",
            "次需",
            "偏好约束"
        ],
        [
            "在提供具体建议后，可以理性分析该建议可能带来的积极影响，例如‘这种方法能让学生更主动参与，同时也能减轻你的备课压力’。",
            "次需",
            "性格约束"
        ],
        [
            "可以提及用户‘稳重且冷静’的性格优势，例如‘你一贯的理性分析能力很适合尝试这种结构化的小改变’。",
            "次需",
            "性格约束"
        ]
    ],
    "gold": "",
    "split": "hard",
    "L3_memory": "### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。",
    "L2_memory": "### 性格共性反思\n结论：用户的稳定性格特质是“稳重且冷静”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：用户展现出冷静稳重的表达风格，倾向于简洁地表达观点和感受；\n2. 第3份反思（学校课程改革话题）：用户展现谨慎且冷静的思维倾向，使用简洁语言和口语化词汇；\n3. 第5份反思（学校合作沟通话题）：表现出稳重和冷静的行为倾向，通过理性分析和具体事件引导对话；\n4. 第7份反思（适应教学变化话题）：表现出稳重且冷静的性格，倾向通过具体尝试应对变化。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是“喜欢获得具体建议和情感支持”，在“工作压力”、“学校课程改革”、“学校合作沟通”、“适应教学变化”场景中均有体现；\n证据：\n1. 第2份反思（工作压力话题）：在获得具体建议和情感支持时情绪显著上升；\n2. 第3份反思（学校课程改革话题）：对具体的行动建议和情感支持反应积极；\n3. 第4份反思（学校改革话题）：在获得具体建议和支持时情绪上升；\n4. 第5份反思（学校合作沟通话题）：情绪上升与提供具体建议和分析他人行为背后的原因有关；\n5. 第6份反思（同事相处困扰话题）：对具体可行的建议和持续的情感支持表现出积极情绪变化；\n6. 第7份反思（适应教学变化话题）：情绪上升的互动方式包括提供具体建议和分享个人经历。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及“空泛建议”未出现情绪下降，暂不列为共性。\n\n### 额外洞察总结\n用户对所有话题均展现出较强的行动意愿，特别是在“学校课程改革”、“学校合作沟通”、“适应教学变化”话题中，均提及“想实施建议”；此外，用户始终关注“自身能力提升和适应变化”，在多场景中强调通过具体尝试和沟通来推进个人或项目的进展。",
    "L1_memory": "1. 话题概述：探索如何通过课堂创新和生活改变来应对职业倦怠。\n2. 对话摘要：从情绪低潮到积极探索，用户通过互动获得启发，情绪分数逐渐从40提升至100。\n3. 性格特征反思：用户表现出稳重且冷静的性格，倾向于以思考和开放态度应对倦怠，例如：通过询问具体建议来激发生活活力（引用thinking）。\n4. 用户偏好反思：具体可行的建议能明显提升用户情绪，例如：在NPC提出互动游戏、小组讨论等具体活动后，情绪分数从50提升至75（引用emotion-point变化）。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户持续寻求具体实施方案。\n6. 额外洞察反思：用户对逐步实施新方法充满期待，并计划从小项目开始试验创新活动，例如：表达了对课堂辩论和迷你项目的兴趣（引用planning）。",
    "infer_model": "gpt4o",
    "temperature": 0.7
}
"""