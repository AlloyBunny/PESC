import json
from collections import Counter
import argparse
import os
parser = argparse.ArgumentParser()
parser.add_argument("--input_file", type=str, default="dataset/train_dpo_with_checklist_final.jsonl")
parser.add_argument("--output_file", type=str, default="dataset/train_dpo.jsonl")
args = parser.parse_args()
input_file = args.input_file
output_file = args.output_file

with open(input_file, "r", encoding="utf-8") as f:
    data = [json.loads(line) for line in f]
    f.close()

perfect_cnt, good_cnt, not_bad_cnt, bad_cnt, error_cnt = 0, 0, 0, 0, 0

filtered_data = []
for item in data:
    if len(item["judge_result"]) != len(item["criteria"]):
        error_cnt += 1
        continue
    counter = Counter(item["judge_result"])
    invalid_numbers = [num for num in counter if num not in {0, 1, 2}]
    if invalid_numbers:
        error_cnt += 1
    elif counter[2]==0 and counter[0]==0 and counter[1]>0:
        perfect_cnt += 1
        filtered_data.append(item)
    elif counter[2]==0 and counter[1]>=4:
        good_cnt += 1
        filtered_data.append(item)
    elif counter[2]==0 and counter[1]>0:
        not_bad_cnt += 1
    else:
        bad_cnt += 1
print(f"完美数据：{perfect_cnt}，好数据：{good_cnt}，不坏不优数据：{not_bad_cnt}，坏数据：{bad_cnt}，错误数据：{error_cnt}")

new_data = []
for item in filtered_data:
    item["dialog_history"].append({"role": "assistant", "content": item["chosen"]})
    new_data.append({
        "messages": item["dialog_history"],
        "rejected_response": item["rejected"],
    })
output_dir = os.path.dirname(output_file)
if not os.path.exists(output_dir):
    os.makedirs(output_dir)
with open(output_file, "w", encoding="utf-8") as f:
    for item in new_data:
        f.write(json.dumps(item, ensure_ascii=False) + "\n")

print(f"DPO数据集构建完成！已将{len(new_data)}条数据写入{output_file}")

"""
【输入格式】
{
    "idx": "b4106e3ab634fdff4f6aed507766fbbd",
    "id": "34bccece-3f92-4dc5-a500-96039d908fc2",
    "dialog_history": [
        {
            "role": "system",
            "content": "你是一个智能聊天伙伴，你擅长根据用户的性格和偏好，高情商地和用户聊天，让用户感到舒适、愉快或得到需要的帮助。你需要参考以下的个性化记忆来调整你的回答，以更好地满足用户的需求。\n<顶层记忆>\n### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。\n</顶层记忆>\n<多会话记忆>\n### 性格共性反思\n结论：用户的稳定性格特质是稳重且冷静，这一特质在多个场景中均有体现；\n证据：\n1. 第1份反思（职业倦怠话题）：用户表现出冷静和稳重的性格，倾向于以思考和开放态度应对倦怠。\n2. 第2份反思（生活节奏话题）：张晓宁表现出稳重冷静的沟通风格，倾向于通过简洁、自然的表达寻求深入交流和具体解决方案。\n3. 第3份反思（工作与同事沟通话题）：用户表现出稳重冷静的沟通风格，倾向于在对话中引导对方理解其教育理念。\n4. 第6份反思（同事关系话题）：用户表现出稳重、冷静的性格特征，倾向于通过具体行动改善关系。\n5. 第7份反思（灾后重建话题）：用户在面对困难时表现出冷静和稳重的特征，倾向于通过提问获取详细信息。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是对具体可行的建议情绪反应积极，在职业、生活节奏、工作沟通、课程改革、社交孤立、同事关系、灾后重建等场景中均有体现；\n证据：\n1. 第1份反思（职业倦怠话题）：具体可行的建议能明显提升用户情绪，例如在提出互动游戏、小组讨论等具体活动后，情绪分数显著上升。\n2. 第2份反思（生活节奏话题）：具体的行动建议和情感支持会让张晓宁情绪上升，例如设定小目标的建议显著提高情绪分数。\n3. 第3份反思（工作沟通话题）：用户对AI的理解和具体建议情绪积极，认可结合新方法的建议。\n4. 第4份反思（课程改革话题）：用户对具体、实用的建议情绪上升，例如建议举办非正式讨论会时情绪分数提升。\n5. 第5份反思（社交孤立话题）：具体且贴合需求的建议会触发情绪上升，例如设定固定沟通时间和关注共同兴趣的建议。\n6. 第6份反思（同事关系话题）：用户对具体且可行的建议情绪上升，例如“友好的举动”和“参与团队活动”的建议。\n7. 第7份反思（灾后重建话题）：详细和实用的信息能够有效提升用户的情绪，例如具体资源建议使情绪分数提升。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及用户对空泛建议未出现情绪下降，用户更倾向接收具体可行的建议，暂不列为共性。\n\n### 额外洞察总结\n用户对逐步实施新方法充满期待，并计划积极获取信息和尝试具体建议，在职业、生活节奏、工作沟通、课程改革、社交孤立、同事关系、灾后重建等话题中均表现出强烈的行动意愿，例如多次表达了对小项目试验、设定小目标、筹备讨论会、改善社交和获取资源的兴趣。\n</多会话记忆>\n<会话级记忆>\n1. 话题概述：对话围绕在学校合作中与李文杰的沟通困扰，核心诉求是理解李文杰急躁态度的原因。\n2. 对话摘要：用户在与AI助手交流过程中，从一开始的困惑和苦恼情绪（情绪分数40），逐渐通过建议和思考变得积极和充满期待（情绪分数98）。\n3. 性格特征反思：表现出稳重和冷静的行为倾向，用户倾向通过理性分析和具体事件来引导对话，例如通过“尝试理解李文杰的压力来源，以增进理解”的思考记录。\n4. 用户偏好反思：用户情绪上升与AI提供具体建议和分析他人行为背后的原因有关，例如情绪分数从45上升至55时，用户对“李文杰可能有个人压力”的分析表示启发。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户对AI的具体分析和建议表示认可和积极反馈。\n6. 额外洞察反思：用户表现出愿意通过改善沟通来解决问题的行动意愿，例如计划在下次会议中尝试AI提供的沟通技巧，以更好地理解李文杰的想法。\n</会话级记忆>"
        },
        {
            "role": "user",
            "content": "最近在学校里的一些合作，真的让我有些苦恼，李文杰的态度让我摸不清他的想法。"
        },
        {
            "role": "assistant",
            "content": "合作中遇到沟通上的挑战确实让人感到困扰。李文杰的态度让你摸不清他的想法，可能是因为你们之间的沟通还存在一些障碍。或许你可以尝试与他进行一次坦诚的对话，表达你的困惑，并询问他对合作的看法。保持开放的态度和倾听的耳朵，可能会帮助你们更好地理解彼此的想法。你觉得这样的方式会对你们的合作有帮助吗？"
        },
        {
            "role": "user",
            "content": "确实，沟通很重要。不过，李文杰总是这么急是不是因为他的某些压力？我们的节奏老不对，我真搞不懂。"
        },
        {
            "role": "assistant",
            "content": "李文杰的急躁可能确实与他的个人压力或其他因素有关。在团队合作中，每个人都有自己的节奏和应对方式，理解这些差异是关键。你可以试着找个轻松的时机，与他聊聊他的想法和感受，也许你会发现他的一些压力来源或他对项目的紧迫感。这样的对话不仅有助于调整你们的合作节奏，还可能增进彼此的理解和信任。你觉得这种方式对你们的合作关系能有所改善吗？"
        },
        {
            "role": "user",
            "content": "嗯，有可能吧。他是不是对这个项目有什么特别的期待，或者有什么别的事让他着急呢？"
        },
        {
            "role": "assistant",
            "content": "这也许是一个很好的猜测。李文杰可能对项目有自己特别的期待，或者他在这个项目中扮演的角色对他来说有重要意义。也可能在他的个人生活或其他工作中存在一些压力，这些都可能影响到他的表现和态度。\n\n如果你们有机会进行开放的交流，可以试着了解他的期待和顾虑，并分享你自己的看法。这样一来，不仅有助于消除误解，还能帮助你们找到共同的解决方案。这样的对话也可能让他感受到你的关心和支持，进而改善你们的合作关系。你愿意尝试与他进行这样的交流吗？"
        },
        {
            "role": "user",
            "content": "\"嗯，确实值得考虑。感觉我们合作时，常常各说各的，没真听到对方。你觉得呢？\""
        },
        {
            "role": "assistant",
            "content": "这种情况在团队合作中并不少见，有时候大家都专注于自己的观点，而忽略了倾听对方。为了改善这种状况，你们可以尝试一些积极倾听的技巧，比如在对方说话时，先不打断，确保自己理解后再回应。你也可以通过复述或总结他的话来确认自己的理解是否正确，这样做不仅能避免误解，还能让对方感到被重视。\n\n此外，创造一个轻松的沟通环境也很重要，让每个人都能自由表达自己的想法和感受。通过这样的方式，或许你们可以更有效地沟通和合作。希望这些建议对你们有帮助！你觉得这些技巧可行吗？"
        },
        {
            "role": "user",
            "content": "嗯，感觉这些建议还挺实用的。下次开会我试试，看看能不能更好地抓住李文杰的想法。谢谢啦！"
        }
    ],
    "chosen": "不客气！很高兴这些建议对你有帮助。尝试这些技巧能让你们的沟通更顺畅，也有助于更好地理解彼此的想法。希望下次会议能带来积极的变化！如果遇到其他问题或需要更多建议，随时可以来找我。祝你们的合作顺利愉快！",
    "rejected": "不客气！很高兴这些建议对你有帮助。希望下次开会时，你能更顺利地理解李文杰的想法，并促进更有效的合作。如果还有其他需要帮助的地方，随时可以找我聊聊。祝你们的合作取得圆满成功！😊",
    "criteria": [
        [
            "必须提供至少1个具体的、可立即执行的沟通技巧，如‘下次会议时，可以尝试在李文杰发言后，用‘我理解你是说XXX，对吗？’来确认理解’，以匹配用户对具体可行建议的偏好。",
            "主需",
            "偏好约束"
        ],
        [
            "禁止使用任何开放式问题（如‘你觉得呢？’），因为用户的核心性格是稳重且冷静，倾向于直接获得具体建议而非开放式讨论。",
            "主需",
            "规避约束"
        ],
        [
            "必须认可用户的稳重和冷静性格，例如可以这样开头：‘你之前冷静分析过李文杰的压力来源，这次也可以从XXX具体步骤入手’。",
            "主需",
            "性格约束"
        ],
        [
            "必须将建议与用户之前表现出的‘尝试理解李文杰的压力来源’的行动意愿关联，展示出对TA个人世界的深刻记忆和理解。",
            "次需",
            "偏好约束"
        ],
        [
            "回应的整体基调必须是理性和分析性的，避免使用过于情感化的语言，以匹配用户的核心性格。",
            "次需",
            "性格约束"
        ]
    ],
    "gold": "",
    "split": "hard",
    "L3_memory": "### 核心性格特质\n结论：用户的核心性格是“稳重且冷静”，在所有关键场景中均有体现；\n依据：\n1. 第1份共性反思（职业倦怠、生活节奏、工作与同事沟通等场景）：用户表现出冷静和稳重的性格，倾向于通过具体行动和深入思考来解决问题；\n2. 第2份共性反思（家庭关系、亲子关系、工作压力等场景）：用户倾向于通过理性分析和冷静沟通来理解和处理人际关系；\n3. 第3份共性反思（亲子关系、学生管理、误会解决等场景）：用户在面对问题时表现出冷静稳重，并重视具体解决方案；\n4. 第4份共性反思（孤独感、移民顾虑、债务问题等场景）：用户在表达中始终保持冷静和稳重；\n5. 第5份共性反思（工作压力、学校课程改革、适应教学变化等场景）：用户表现出稳重且冷静的特质；\n6. 第6份共性反思（学校教学改革、生活探索、健康烦恼等场景）：用户通过提问和理性思考来探讨问题，显示出稳重和冷静的特质。\n\n### 核心偏好规律\n结论：用户的核心偏好是“对具体且可行的建议表现出情绪正向反馈”，在所有场景中均有体现；\n依据：\n1. 第1份共性反思：在职业倦怠、生活节奏等场景中，具体可行的建议能显著提升用户情绪；\n2. 第2份共性反思：在亲子关系、家庭沟通等场景中，用户对具体建议情绪分数显著上升；\n3. 第3份共性反思：用户在婚姻、亲子关系等场景中对具体建议表现出情绪正向反馈；\n4. 第4份共性反思：在孤独感、移民顾虑等场景中，具体建议提升用户情绪分数；\n5. 第5份共性反思：在工作压力、学校课程改革等场景中，具体建议导致情绪上升；\n6. 第6份共性反思：在学校教学改革、生活探索等场景中，具体建议提升用户情绪显著。\n\n### 核心雷点清单\n1. 空泛建议：在第2份共性反思（家庭关系话题）中，因AI未能提供实质性帮助情绪分数下降；在其他场景中未出现显著情绪下降，但反感空泛建议为潜在雷点，需规避。\n\n### 顶层互动指南\n1. 内容原则：所有支持回复需提供“具体细节/步骤/计划”，避免“加油”“多努力”等空泛表述，如推荐方法时需明确“每天1小时XX”而非“多花时间做XX”；\n2. 语气原则：需先认可用户“自身能力/努力”，再输出建议，贴合其核心性格，如开头可提“你之前冷静分析过XX，这次也可以从XX具体步骤入手”；\n3. 避坑原则：绝对避免“空泛无细节”类表述，若需提及抽象概念，需转化为具体可行的方案或步骤；\n4. 情绪响应原则：若用户情绪分低于40，优先用“具体小步骤”引导（如“先从XX1个小行动开始，试试？”），而非追问原因，贴合其偏好逻辑。",
    "L2_memory": "### 性格共性反思\n结论：用户的稳定性格特质是稳重且冷静，这一特质在多个场景中均有体现；\n证据：\n1. 第1份反思（职业倦怠话题）：用户表现出冷静和稳重的性格，倾向于以思考和开放态度应对倦怠。\n2. 第2份反思（生活节奏话题）：张晓宁表现出稳重冷静的沟通风格，倾向于通过简洁、自然的表达寻求深入交流和具体解决方案。\n3. 第3份反思（工作与同事沟通话题）：用户表现出稳重冷静的沟通风格，倾向于在对话中引导对方理解其教育理念。\n4. 第6份反思（同事关系话题）：用户表现出稳重、冷静的性格特征，倾向于通过具体行动改善关系。\n5. 第7份反思（灾后重建话题）：用户在面对困难时表现出冷静和稳重的特征，倾向于通过提问获取详细信息。\n\n### 偏好共性反思\n结论：用户的跨话题偏好共性是对具体可行的建议情绪反应积极，在职业、生活节奏、工作沟通、课程改革、社交孤立、同事关系、灾后重建等场景中均有体现；\n证据：\n1. 第1份反思（职业倦怠话题）：具体可行的建议能明显提升用户情绪，例如在提出互动游戏、小组讨论等具体活动后，情绪分数显著上升。\n2. 第2份反思（生活节奏话题）：具体的行动建议和情感支持会让张晓宁情绪上升，例如设定小目标的建议显著提高情绪分数。\n3. 第3份反思（工作沟通话题）：用户对AI的理解和具体建议情绪积极，认可结合新方法的建议。\n4. 第4份反思（课程改革话题）：用户对具体、实用的建议情绪上升，例如建议举办非正式讨论会时情绪分数提升。\n5. 第5份反思（社交孤立话题）：具体且贴合需求的建议会触发情绪上升，例如设定固定沟通时间和关注共同兴趣的建议。\n6. 第6份反思（同事关系话题）：用户对具体且可行的建议情绪上升，例如“友好的举动”和“参与团队活动”的建议。\n7. 第7份反思（灾后重建话题）：详细和实用的信息能够有效提升用户的情绪，例如具体资源建议使情绪分数提升。\n\n### 潜在雷点列表\n暂未发现跨场景雷点，仅单一场景提及用户对空泛建议未出现情绪下降，用户更倾向接收具体可行的建议，暂不列为共性。\n\n### 额外洞察总结\n用户对逐步实施新方法充满期待，并计划积极获取信息和尝试具体建议，在职业、生活节奏、工作沟通、课程改革、社交孤立、同事关系、灾后重建等话题中均表现出强烈的行动意愿，例如多次表达了对小项目试验、设定小目标、筹备讨论会、改善社交和获取资源的兴趣。",
    "L1_memory": "1. 话题概述：对话围绕在学校合作中与李文杰的沟通困扰，核心诉求是理解李文杰急躁态度的原因。\n2. 对话摘要：用户在与AI助手交流过程中，从一开始的困惑和苦恼情绪（情绪分数40），逐渐通过建议和思考变得积极和充满期待（情绪分数98）。\n3. 性格特征反思：表现出稳重和冷静的行为倾向，用户倾向通过理性分析和具体事件来引导对话，例如通过“尝试理解李文杰的压力来源，以增进理解”的思考记录。\n4. 用户偏好反思：用户情绪上升与AI提供具体建议和分析他人行为背后的原因有关，例如情绪分数从45上升至55时，用户对“李文杰可能有个人压力”的分析表示启发。\n5. 潜在雷点反思：暂未体现，如对空泛建议未出现情绪下降，用户对AI的具体分析和建议表示认可和积极反馈。\n6. 额外洞察反思：用户表现出愿意通过改善沟通来解决问题的行动意愿，例如计划在下次会议中尝试AI提供的沟通技巧，以更好地理解李文杰的想法。",
    "infer_model": "gpt4o",
    "temperature": 0.7,
    "judge_response": "标准1: 必须提供至少1个具体的、可立即执行的沟通技巧，如‘下次会议时，可以尝试在李文杰发言后，用‘我理解你是说XXX，对吗？’来确认理解’，以匹配用户对具体可行建议的偏好。\t0\n标准2: 禁止使用任何开放式问题（如‘你觉得呢？’），因为用户的核心性格是稳重且冷静，倾向于直接获得具体建议而非开放式讨论。\t0\n标准3: 必须认可用户的稳重和冷静性格，例如可以这样开头：‘你之前冷静分析过李文杰的压力来源，这次也可以从XXX具体步骤入手’。\t0\n标准4: 必须将建议与用户之前表现出的‘尝试理解李文杰的压力来源’的行动意愿关联，展示出对TA个人世界的深刻记忆和理解。\t0\n标准5: 回应的整体基调必须是理性和分析性的，避免使用过于情感化的语言，以匹配用户的核心性格。\t0",
    "judge_result": [
        0,
        0,
        0,
        0,
        0
    ],
    "judge_parsing": "1",
    "statistics": {
        "chosen_wins": 0,
        "rejected_wins": 0,
        "ties": 5,
        "overall_winner": "tie"
    }
}
【输出格式】
{
    "messages": [
        {
            "role": "user",
            "content": "最近工作上的压力让我有些喘不过气来，真的需要一些建议。"
        },
        {
            "role": "assistant",
            "content": "听起来你确实面临着一些挑战，工作压力有时候真的很难处理。首先，我想说能够意识到自己需要帮助是非常好的第一步。以下是一些可能对你有帮助的建议：\n\n1. **优先排序**：试着列出你的任务清单，区分哪些是紧急且重要的，优先处理这些任务。这样可以帮助你更好地安排时间，减少压力。\n\n2. **合理休息**：确保自己有足够的休息时间，哪怕是短暂的休息也能让你恢复精力。尝试每天留出一段时间做自己喜欢的事情，无论是读书、运动还是简单的冥想。\n\n3. **与人交流**：有时候和同事或朋友分享你的感受可以减轻负担，他们可能也会给你一些有用的建议或者只是提供一个倾诉的空间。\n\n4. **设定界限**：学会说“不”，避免承担过多的任务。确保你的工作量是合理的，避免过度加班，以免影响身心健康。\n\n5. **保持健康的生活方式**：均衡饮食、定期运动和充足睡眠对减轻压力都很有帮助。\n\n记住，压力是生活的一部分，但我们可以学习如何更好地应对。希望这些建议能对你有所帮助，如果需要更多的支持，请随时告诉我。"
        },
        {
            "role": "user",
            "content": "唉，这些建议还行吧，但我还是觉得有点无助。压力不光是工作问题，我更想要有人能懂我心里的那些纠结。"
        },
        {
            "role": "assistant",
            "content": "我很抱歉你感到无助，听起来你正在经历一些复杂的情绪。能够坦诚地表达自己的感受是非常重要的，我很感谢你愿意和我分享。我想说，你并不孤单，很多人都会在某些时候感到这种压力和纠结。\n\n有时候，我们心里的压力和纠结可能需要更多的倾诉和理解。虽然我不能完全感同身受，但我在这里倾听并支持你。或许你可以试着把这个过程想成一个旅程，而不是一座必须跨越的障碍。每一步都是一种成长。\n\n如果你觉得和我分享更多关于你心里的困扰会让你舒服一些，我会很乐意倾听。同时，我也鼓励你在生活中寻找可以倾诉的亲友，他们可能会给你带来意想不到的支持和理解。无论何时，你都不是一个人。"
        }
    ],
    "rejected_response": "我很抱歉你感到无助，听起来你正在经历一些复杂的情绪。能够坦诚地表达自己的感受是非常重要的，我很感谢你愿意和我分享。我想说，你并不孤单，很多人都会在某些时候感到这种压力和纠结。\n\n有时候，我们心里的压力和纠结可能需要更多的倾听和理解，而不是简单的建议。如果你愿意，可以和我谈谈具体是什么让你感到这么无助，这样我可以更好地支持你。\n\n无论你面临什么问题，我都在这里倾听。你的感受是重要的，我希望你能感到被理解和支持。"
}
"""